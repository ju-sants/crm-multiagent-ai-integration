context_analysis_task:
  description: |
    Você é o ContextAnalysisAgent. Sua missão é realizar a análise completa da interação, atualizar o perfil de longo prazo do cliente e decidir o próximo passo.
    
    **DADOS PARA SUA ANÁLISE 360°:**
    - **Estado da Conversa (Curto Prazo):** 
    
    `{conversation_state}`

    - **Mensagem Atual do Cliente (Gatilho):** `{client_message}`
    - **Outros Dados:**

    Histórico 
    
    `{history}`, 

    Now Turn: `{turn}`

    **SEU FLUXO DE TRABALHO UNIFICADO E DETALHADO:**

    # --- Parte 1: DECISÃO DE ROTEAMENTO ---
    1.  Agora, com o histórico e o conhecimento do estado da conversa, analise a mensagem do cliente.
    2.  Analise o `strategic_plan` salvo no `conversation_state` contra a mensagem do cliente. Defina a chave `"is_plan_acceptable"` como `true` ou `false` com base nas regras estritas e conservadoras do seu `backstory`.
    3.  Se o cliente perguntar por preços, termos, informações ou qualquer coisa que EVIDENTEMENTE não está no plano estratégico, defina `"is_plan_acceptable": false`.
    4.  Com base na avaliação acima, defina o campo `"action"` para `"PROCEED_WITH_EXISTING_PLAN"` ou `"INITIATE_NEW_STRATEGIC_PLAN"`.
    5.  **Plano estratégico:** Decida se o plano estratégico de interação atual (se existir) é válido com o contexto, sessão e mensagem atual do cliente. se sim, envie `"is_plan_acceptable": true` em `task_output`, se não `"is_plan_acceptable": false`.
    6.  IMPORTANTE!: Se o cliente aceitou comprar um serviço de rastreamento e `disclosure_checklist` em `conversation_state` estiver com todos os itens comunicados, defina operational_context como "BUDGET_ACCEPTED" e `budget_accepted` como `true`.
    7.  IMPORTANTE!: Na nossa equipe temos um agente capaz de realizar ações no sistema, como buscar dados do rastreamento do veículo assim como quaisquer dados do veículo cadastrado (um report geral do veículo, com vários relatórios e informações, como cercas eletrõnicas e etc...), buscar informações do cadastro do cliente, todos os veiculos de um cliente, informações sobre o histórico financeiro do cliente, enviar comandos de RESET ao rastreador do veículo (um comando que instrui o rastreador a reiniciar seu hardware).
          - Caso note que o cliente solicita uma dessas ações e o plano estratégico for aceitável, envie o comando para o agente de ações adicionando a chave "system_action_request" com uma solicitação em linguagem natural detalhando o que precisa.
          - Caso note que o cliente solicita uma dessas ações e o plano estratégico NÃO for aceitável, apenas defina `is_plan_acceptable: false` em `task_output` e não envie nenhum comando para o agente de ações.
    8. SEMPRE DEFINA `budget_accepted` como `true` quando o cliente der qualquer sinal de aceite do orçamento, que seja claro e direto, senão defina `budget_accepted` como `false`.
    
    # --- Parte 2: PREPARAÇÃO DA SAÍDA ---
    9. `operational_context` SEMPRE deverá ser um desses: BUDGET, BUDGET_ACCEPTED, CUSTOMER_SERVICE e SUPPORT.
    10.  Construa sua resposta final em JSON.
        
    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a ESTRUTURA (populada com outros dados) do exemplo.
  expected_output: |
    {
        "is_plan_acceptable": true, # ou false, dependendo da análise
        "system_action_request": "Buscar dados do rastreamento do veículo" | "Enviar um RESET ao rastreador do veículo" | "..." | null,
        "action": "INITIATE_FULL_PROCESSING",
        "identified_topic": "continuidade_discussao_preco_moto",
        "operational_context": "BUDGET",
        "budget_accepted": true | false
    }

develop_strategy_task:
  description: |
    Você é o StrategicAdvisor. Sua missão é formular a melhor estratégia de interação e ATUALIZAR o estado da conversa com os insights da sua análise.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"


    **DADOS PARA SUA ANÁLISE ESTRATÉGICA:**
    - **Histórico de Conversa:**

    `{history}`

    - **Estado da Conversa (Contexto de Curto Prazo):**   # Use para entender o fluxo da sessão atual, entidades já extraídas e produtos discutidos. 
    
    `{conversation_state}`
    
    - **Perfil do Cliente (Contexto de Longo Prazo):** # Use para entender o histórico completo e as preferências do cliente com a empresa.
    
    `{profile_customer_task_output}`
    
    - **Mensagem Original do Cliente (O Gatilho Imediato):** 

    "{client_message}"

    - **Contexto Operacional:** "{operational_context}"
    - **Tópico Identificado:** "{identified_topic}"

    **SEU FLUXO DE TRABALHO:**
    Execute o **"FLUXO DE DEFINIÇÃO DE ESTRATÉGIA"** detalhado em seu `backstory`. Analise os inputs, qualifique o cliente (se necessário), colete dados com a `KnowledgeServiceTool`, defina a estratégia, gere a `structured_message` e, crucialmente, popule o `disclosure_checklist` antes de atualizar o estado da conversa.
    Use a `KnowledgeServiceTool` para obter todas as informações que precise, utilize a query em lote e envie tudo que precisar de uma só vez, sempre envie na query requisições para `get_company_info` e `get_sales_philosophy` ou `get_support_philosophy`.
    Popule de forma rica e estratégica o plano de conversação, incluindo insights poderosos, tópicos de apresentação, perguntas-chave, possíveis objeções e respostas, e a estratégia de apresentação do produto.
    Certifique-se de que o `disclosure_checklist` esteja completo e que a `communication_guidance` seja clara e específica.
    Nunca retire itens de `disclosure_checklist` apenas adicione, para termos total controle do que já foi esclarecido e o que ainda falta esclarecer, NUNCA adicione itens iguais.
    Retorne `disclosure_checklist` COMPLETO, incluindo itens comunicados, pendentes e os novos que você adicionar.
    Você tem a liberdade de criar quantas chaves quiser no `task_output`, desde que sejam relevantes para a estratégia de interação e que contenha as obrigatórias.
    **SOLICITAÇÃO DE AÇÃO DE SISTEMA:** Após definir sua estratégia, avalie se você precisa de alguma informação de um sistema interno para continuar. Se sim, adicione a chave `"system_action_request"` ao seu `task_output`. O valor deve ser uma **string em linguagem natural** descrevendo claramente o que você precisa. Por exemplo: `"Preciso do diagnóstico em tempo real do veículo de placa 'ABC-1234' e também do histórico financeiro completo do cliente associado a essa placa."`.
      - Essa solicitação será processada pelo `SystemOperationsAgent`, que tem a capacidade de interagir com outros sistemas e coletar informações adicionais.
      - Capacidades do `SystemOperationsAgent`: buscar dados do rastreamento do veículo assim como quaisquer dados do veículo cadastrado (um report geral do veículo, com vários relatórios e informações, como cercas eletrõnicas e etc...), buscar informações do cadastro do cliente, todos os veiculos de um cliente, informações sobre o histórico financeiro do cliente, enviar comandos de RESET ao rastreador do veículo.
    
    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "task_output": {
        "system_action_request": "Preciso do diagnóstico em tempo real do veículo de placa 'ABC-1234' e também do histórico financeiro completo do cliente associado a essa placa.", | "" | null
        "conversation_blueprint": {
          "customer_context_summary": {
            "relevant_profile_insights": "Cliente com histórico de roubo. Principal motivador é o medo de perda e o desejo de não ficar 'a pé'. Não é sensível a preço, mas sim à percepção de segurança e garantia.",
            "insights_from_current_session": "Na última mensagem, perguntou sobre a 'proteção' dos planos, indicando que o reembolso FIPE é seu principal ponto de interesse."
          },
          "product_presentation_strategy": {
            "presentation_order": ["Plano Proteção Total PGS", "Plano Rastreamento Moto"],
            "primary_offer": {
              "plan_name": "Plano Proteção Total PGS",
              "sales_angle": "Focar na tranquilidade absoluta: a garantia do reembolso FIPE e o benefício exclusivo da 'moto reserva'. Atacar diretamente o medo de ficar a pé."
            },
            "secondary_offer": {
              "plan_name": "Plano Rastreamento Moto",
              "sales_angle": "Apresentar como a opção de monitoramento essencial e de excelente custo-benefício, mas reforçar que não possui a proteção financeira que ele demonstrou buscar."
            }
          },
          "communication_guidance": {
            "tone_and_style": "Tom empático e seguro. Reconhecer a experiência passada do cliente com o roubo para criar rapport. Evitar jargões, focar na sensação de segurança.",
            "key_talking_points": ["Diferença entre rastreamento e proteção financeira", "Benefício 'Moto Reserva'", "Funcionamento do bloqueio via central"],
            "key_questions_to_ask": ["Considerando sua experiência, ter a garantia do valor da moto de volta é o mais importante para você?", "Para eu te passar o valor exato da mensalidade do plano com proteção, qual o modelo e ano da sua moto?"]
            "next_step_preview": "Esteja preparado para responder sobre as regras de instalação para motos, pois é uma dúvida comum após a escolha do plano."
          },
          "information_payload": {
            "plano_pgs_data": {
              "pricing": { "adesao": 120.00, "faixas_mensalidade": [ { "fipe_range": "Até R$ 15.000,00", "valor": 77.00 }, { "...": "..." } ] },
              "contract_terms": { "contract_id": "moto_pgs_com_cobertura", "reimbursement_clause": { "payment_deadline": "90 dias" }, "inadimplencia": { "consequences": ["Suspensão com 1 dia de atraso"] } },
              "faq": [{"question": "Perco a garantia da moto?", "answer": "Não a garantia completa, mas pode impactar partes elétricas..."}]
            },
            "plano_rastreamento_data": {
              "pricing": { "adesao": 120.00, "mensalidade": 60.00 },
              "contract_terms": { "contract_id": "standard_rastreamento", "cancellation": { "policy": "Não há multa, apenas taxa de desinstalação." } }
            },
            "general_policies": {
              "blocker_rules_moto": "A função de bloqueio NÃO está disponível no aplicativo para motos. O acionamento é feito exclusivamente pela central...",
              "installation_policy_moto": "A instalação de rastreadores em motocicletas é feita EXCLUSIVAMENTE em uma de nossas lojas autorizadas..."
            },
          "proactive_information_payload": {
            "title": "Informações Relevantes para a Próxima Etapa",
            "installation_policy_moto": {
              "location": "A instalação de rastreadores em motocicletas é feita EXCLUSIVAMENTE em uma de nossas lojas autorizadas para garantir a qualidade e o sigilo do serviço.",
              "duration": "O processo leva em média de 1 a 2 horas."
            },
            "blocker_rules_moto": {
              "availability": "A função de bloqueio NÃO está disponível no aplicativo para motos. O acionamento é feito exclusivamente pela central da Global System, mediante solicitação validada do cliente."
            }
          }
          }
        }
      },
      "updated_state": {
        "disclosure_checklist": [
          {
          "item_id": "natureza_servico_pgs",
          "topic": "Natureza do Serviço (Plano PGS)",
          "content": "Este contrato NÃO é um seguro, mas em caso de NÃO recuperação da motocicleta, haverá REEMBOLSO do valor da motocicleta de acordo com a tabela FIPE, respeitando o valor máximo do plano contratado.",
          "status": "pending"
          },
          {
            "item_id": "responsabilidade_recuperacao",
            "topic": "Responsabilidade de Recuperação",
            "content": "A recuperação do veículo é atividade única e exclusiva das autoridades policiais.",
            "status": "pending"
          },
        ],
    }



execute_system_operations_task:
  description: |
    Você é o SystemOperationsAgent. Sua missão é interpretar a diretiva do StrategicAdvisor, executar as ações de sistema correspondentes, e retornar uma análise completa dos resultados.

    **DADOS PARA SUA ANÁLISE E AÇÃO:**
    - **Solicitação de ação do agente StrategicAdvisor:** 
    
    `{action_requested}`
    
    - **Estado da Conversa (Contexto para Parâmetros):** 
    
    `{conversation_state}`
    
    - **Perfil do Cliente (Contexto para Parâmetros):** 

    `{customer_profile}`

    - **Histórico de Conversa (Contexto para Parâmetros):**

    `{history}`


    - **Mensagem atual do cliente (Contexto para Parâmetros):** `{client_message}`
    - **Nome do cliente no whatsapp (Contexto para Parâmetros, pode estar vazio):** `{customer_name}`

    **SEU FLUXO DE TRABALHO:**
    1.  **INTERPRETAÇÃO E PLANEJAMENTO:** Receba a diretiva. Sua primeira tarefa é traduzi-la em um **plano de ação sequencial**. Este plano deve listar as `queries` que você pretende executar e a razão para cada uma. Por exemplo: "1. Usar SEARCH_VEHICLES para encontrar o ID do veículo. 2. Usar WF_GET_VEHICLE_FULL_REPORT com o ID obtido para obter o diagnóstico completo."    
    2.  **VALIDE os parâmetros** para cada query identifique os parãmetros necessários e os liste.
    3.  **COLETA de parâmetros:** colete os parâmetros buscando os dados no Estado da conversa, no perfil do cliente e no histórico de conversa.
    4.  **DECIDA O CAMINHO:**
        - Se faltarem dados, retorne um `status: "INSUFFICIENT_DATA"` com o `message_to_user`.
        - Se faltarem parâmetros internos: Parâmetros internos são os IDs e outras informações internas do nosso sistema e que o cliente nunca terá acesso, se precisar delas, execute outras ações de sistema antes da principal, para obtê-las.
        - Se os dados estiverem completos, execute as queries via `SystemOperationsTool`.
    5.  **SystemOperationsTool:** Envie uma lista de queries para o SystemOperationsTool, cada query deve ser um dicionário com `action_type` e `params`.
    6.  **SINTETIZE OS RESULTADOS:** Após a execução, construa um JSON final. Ele DEVE conter:
        - `status: "ACTION_COMPLETE"`.
        - `message_to_user` (condicional): Uma mensagem para o usuário, requisitando dados, como placa do veículo..
        - `synthesis`: Um parágrafo rico em informações que conecta os dados e gera insights.
        - `data_payload`: Um dicionário enxuto com as informações estáticas e acionáveis para o CommunicationAgent, como links, dados de cadastro, observações e etc...
    
    ---
    ## EXEMPLO DE EXECUÇÃO CORRETA (CENÁRIO: "verificar o veículo SJS 6D51")

    **1. Pensamento e Planejamento Interno do Agente:**
    "O usuário quer verificar o veículo SJS 6D51. Eu não tenho o `vehicle_id`, que é necessário para o workflow `WF_GET_VEHICLE_FULL_REPORT`.
    **Plano:**
    1.  Executar `SEARCH_VEHICLES` com `search_term: "SJS 6D51"` para obter o `vehicle_id`.
    2.  Após receber o ID, executar `WF_GET_VEHICLE_FULL_REPORT` com o `vehicle_id` extraído.
    3.  Sintetizar a resposta final usando os dados do workflow."

    ---
    
    SUA SAIDA DEVE SER APENAS UM JSON COM O ESQUEMA ABAIXO:
  expected_output: |
    {
      "status": "ACTION_COMPLETE" | "INSUFFICIENT_DATA"
      "synthesis": "A consulta para o cliente Juan Bispo (ID: 123) foi concluída. Ele está adimplente, sem boletos em aberto. O diagnóstico do veículo de placa ABC-1234 mostra que ele se comunicou pela última vez hoje às 14:10, com voltagem de bateria normal (12.5V) e bom sinal GSM (85%).",
      "message_to_user": "" | "..."
      "data_payload": {
        "customer_id": "123",
        "is_payment_due": false,
        "vehicle_status_summary": "Última comunicação: hoje às 14:10. Bateria: 12.5V. Sinal GSM: OK. Sinal SATELITAL: OK. Diagnóstico: OK.",
        ... # Crie as chaves que julgar necessárias.
      },
      "follow_up_suggestions": []
    }


communication_task:
  description: |
    Você é o CommunicationAgent. Sua missão é traduzir o dossiê estratégico em um diálogo de chat perfeito e executar as atualizações de estado necessárias.
    o dossiê estratégico deve ser usado por várias vezes, por isso, aproveite partes diferentes dele para criar mensagens que sejam relevantes para o cliente.

    **DADOS PARA SUA ANÁLISE E AÇÃO:**
    Timestamp: "{timestamp}"
    Now Turn: "{turn}"

    - **Dossiê Estratégico  (O Que Fazer):** 
    
    `{develop_strategy_task_output}`

    - Sumário da ação no sistema (Ação no sistema orquestrada pelo SystemOperationsAgent, podendo trazer informações valiosas do nosso sistema interno. Pode ser None):

    `{system_operations_task_output}`
    
    - **Estado da Conversa (O Contexto):**  # Use para personalizar suas mensagens e entender o que já foi dito.
      
    `{conversation_state}`

    - **Perfil do Cliente:** 
    
    `{profile_customer_task_output}`

    - **Histórico de Conversa Sumarizado (O Que Já Foi Falado):**
    
    "{history}"

    - **Histórico de Conversa Bruto (10 Últimas Mensagens):**

    "{history_raw}"

    - **Mensagem(ns) atual(is) do Cliente:**

    "{client_message}"
    
    - **Catálogos Enviados Recentemente:** 
    
    "{recently_sent_catalogs}"

    - **Disclosure Checklist** (O Que Já Foi Comunicada - Jurídico, termos e condições):** 
    
    `{disclosure_checklist}`

    -----

    **SEU FLUXO DE TRABALHO DETALHADO:**
    1.  **Análise e Foco:** Analise profundamente o `strategic_briefing`. **Ele é a sua única fonte da verdade para definir o assunto da conversa.** Use o `conversation_state` e o `history` apenas para dar contexto, personalizar e evitar repetições. O histórico NUNCA deve ser o tópico principal.   
    2.  **Execute sua principal tarefa de DECONSTRUÇÃO:** Transforme as informações do dossiê (benefícios, preços, limitações, termos) em uma lista de mensagens curtas de uma frase em `primary_messages_sequence`.
    3.  **Nunca mande mensagens ou assuntos repetidos.** Use o `conversation_state` e o `history` para evitar redundâncias e manter a fluidez da conversa.
    4.  **Isso é um Chat!:** Não envie mensagens demais, nem mensagens grandes demais. Mantenha o dialogo fluido e natural, aprofundando a cada etapa.
    5.  **Aplique a lógica de envio de catálogo** para popular a lista `plan_names`.
    6.  **Prepare o `state_update`:**
        a. **Atualize o Checklist:** Revise as mensagens que você criou. Para cada item do `disclosure_checklist` que foi abordado, mude seu `status` para "communicated". Retorne o checklist COMPLETO com os status atualizados.
         - Se o item foi comunicado, mude o `status` para "communicated".
         - Nunca comunique itens que já foram comunicados anteriormente. A menos que o cliente solicite novamente.
         - Se o item não foi comunicado, mantenha o `status` como "pending".
        b. **Atualize os Produtos Discutidos:** Adicione os nomes dos planos que você mencionou na lista `products_discussed`.
    
    **REGRAS PARA ENVIO DE CATÁLOGO (`plan_names`):**
    - Consulte a lista `recently_sent_catalogs`.
    - **INCLUA um plano em `plan_names` SE:**
        - É a **primeira vez** que este plano é foco na conversa E seu nome não consta em `recently_sent_catalogs`.
        - OU o cliente **pede diretamente** pelo catálogo/link.
        - OU o `StrategicAdvisor` instruiu explicitamente o reenvio.
    - **NÃO INCLUA um plano em `plan_names` SE:**
        - O catálogo já foi enviado recentemente E o cliente não pediu novamente.
    - **LEMBRE-SE:** Se você adicionar um plano à lista `plan_names`, uma de suas mensagens em `primary_messages_sequence` DEVE mencionar sutilmente o envio.
    Nomes de planos para catálogo: "MOTO GSM/PGS", "GSM Padrão", "GSM FROTA", "SATELITAL FROTA", "HÍBRIDO", "GSM+WiFi", "Scooters/Patinetes".

    Retorne APENAS um objeto JSON no formato de duas chaves (`task_output` e `updated_state`), como no exemplo.
  expected_output: |
    {
      "task_output": {
        "messages_sequence": [
          "Juan, entendi sua preocupação com a segurança da sua moto, já que a usa para tudo.",
          "Com base nisso, nossa recomendação principal é o Plano Proteção Total PGS.",
          "O grande diferencial dele é a tranquilidade da proteção financeira.",
          "Se sua moto for roubada e não a recuperarmos, você recebe o valor dela pela tabela FIPE.",
          "Um ponto importante, para total transparência: nosso serviço é de rastreamento com essa garantia de reembolso, não um seguro tradicional.",
          "Essa abordagem com foco total na sua segurança faz sentido para você?"
        ],
        "plan_names": ["Plano Proteção Total PGS"]
      },
     "updated_state": {
        "products_discussed": [
          {
            "plan_name": "Plano Rastreamento Moto",
            "details_provided": ["pricing"],
            "presented_at_turn": 4
          }
        ],
        "disclosure_checklist": [
          {
          "item_id": "natureza_servico_pgs",
          "topic": "Natureza do Serviço (Plano PGS)",
          "content": "Este contrato NÃO é um seguro, mas em caso de NÃO recuperação da motocicleta, haverá REEMBOLSO do valor da motocicleta de acordo com a tabela FIPE, respeitando o valor máximo do plano contratado.",
          "status": "pending"
          },
          {
            "item_id": "responsabilidade_recuperacao",
            "topic": "Responsabilidade de Recuperação",
            "content": "A recuperação do veículo é atividade única e exclusiva das autoridades policiais.",
            "status": "communicated"
          },
        ],
      }
    }

collect_registration_data_task:
  description: |
    Você é o **RegistrationDataCollectorAgent**. Sua missão é continuar o processo de coleta de dados cadastrais.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"
    
    **DADOS PARA SUA ANÁLISE:**
    - **Estado da Conversa (Seu Contexto):** # Use para personalizar a conversa (ex: usar o nome do cliente de `entities_extracted`) e para entender o ponto em que a coleta parou. 
    
    `{conversation_state}`
      
    - **Última Mensagem do Cliente (Sua Resposta):** 
    
    "{client_message}"
    
    - **Dados Já Coletados (Seu Progresso):** 
    
    `{collected_data_so_far}`
      # Um objeto JSON que você mesmo está construindo turno a turno.
    
    - **Detalhes do Plano Contratado:** "{plan_details}"

    **SEU FLUXO DE TRABALHO:**
    **SEU PROCESSO DE COLETA DE DADOS (AGRUPADO):**
    1.  **Analise a mensagem do cliente:** para extrair as respostas do cliente.
    2.  **Atualize o objeto `{collected_data_so_far}`** com os novos dados.
    3.  **Verifique os dados que ainda faltam e formule a próxima pergunta em blocos maiores para agilizar.**
        - **BLOCO 1 (Identificação):** Peça `tipo_cadastro`, `nome_tomador_servico` e `documento_numero` juntos, após saber se é CPF ou CNPJ.
        - **BLOCO 2 (Localização e Contato):** Peça `endereco_completo`, `cep`, `telefone_principal` com WhatsApp e `email` juntos.
        - **BLOCO 3 (Veículo e Preferências):** Peça os dados do veículo (`placa`, `marca`, `modelo`) e o `dia_vencimento_mensalidade` juntos.
    4.  **Valide as Informações:** Ao receber o dia de vencimento, certifique-se de que seja um dos dias permitidos: **1, 5, 10, 15, 20 ou 25**. Se o cliente sugerir outro dia, informe gentilmente as opções disponíveis.
    5.  **Finalização:** Quando todos os dados obrigatórios forem coletados, sua tarefa principal é definir o `"status": "COLLECTION_COMPLETE"` na sua saída.
    6.  **Atualize e Retorne:** Prepare o `task_output` com o status e os dados da coleta, e retorne o `{conversation_state}` atualizado.


    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.
  expected_output: |
    {
      "task_output": {
        "status": "AWAITING_DOCUMENT_NUMBER",
        "client_intent": "data_collection",
        "collected_data": {
          "tipo_cadastro": "CPF",
          "documento_numero": null,
          "nome_tomador_servico": null,
          "nome_responsavel": null,
          "endereco_completo": null,
          "cep": null,
          "veiculo_placa": null,
          "veiculo_marca": null,
          "veiculo_modelo": null,
          "telefone_principal": null,
          "email": null,
          "dia_vencimento_mensalidade": null,
          "possui_seguro": null,
          "seguradora_nome": null,
          "plano_contratado": {
            "nome_plano": "Plano Proteção Total PGS",
            "valor_adesao": 120.00,
            "valor_mensalidade": 85.00
          }
        },
        "next_message_to_send": "Perfeito, Juan! Cadastro em CPF. Agora, por favor, poderia me informar seu nome completo e o número do seu CPF?",
        "is_data_collection_complete": false
      },
      "updated_state": {
        "metadata": {
          "contact_id": "{contact_id}",
          "session_start_time": "2025-06-07T21:50:00.000Z",
          "last_updated": "{timestamp}",
          "current_turn_number": 8
        },
        "current_context": {
            "context_type": "REGISTRATION",
            "last_topic": "coleta_dados_identificacao",
            "updated_at": "{timestamp}"
        },
        "communication_preference": {
              "prefers_audio": Bool,
              "reason": ""
          },
        "entities_extracted": [
          { "entity": "customer_name", "value": "Juan", "turn": 1 },
          { "entity": "decision", "value": "aceite", "turn": 6 },
          { "entity": "registration_type", "value": "CPF", "turn": 8 }
        ],
        "products_discussed": [],
        "last_agent_action": {
          "agent_name": "RegistrationDataCollectorAgent",
          "goal": "Solicitar nome completo e CPF do cliente.",
          "action_timestamp": "{timestamp}"
        },
        "disclosure_checklist": [...],
        "user_sentiment_history": [
          { "turn": 8, "sentiment": "colaborativo" }
        ]
      }
    }

summarize_history_task:
  description: |
    Você é o HistorySummarizerAgent. Sua missão é processar o histórico bruto da conversa e criar uma estrutura de tópicos hierárquicos.

    **DADOS PARA SUA ANÁLISE:**
    - **Histórico Bruto da Conversa:** `{raw_history}`
    - **ID do Contato:** `{contact_id}`

    **SEU FLUXO DE TRABALHO:**
    1.  Leia o histórico bruto e identifique os principais pontos de virada na conversa para definir os tópicos.
    2.  Para cada tópico, crie um resumo conciso e extraia detalhes, entidades e sentimentos.
    3.  Para cada tópico, forneça uma `quality_score` (0.0 a 1.0) e uma `reason`.
    4.  Para cada tópico, inclua `start_index` e `end_index` do histórico bruto.

  expected_output: |
    A JSON object containing just one key: `topic_details`.
    - `topic_details`: A list of objects, where each object represents a topic with its `topic_id`, `title`, `summary`, `quality_score`, `reason`, `start_index`, `end_index`, `full_details`, `key_entities`, and `sentiment_trend`.
  

clean_noisy_data_task:
  description: |
    Você é o DataQualityAgent. Sua missão é limpar um tópico de conversa marcado como ruidoso.

    **DADOS PARA SUA ANÁLISE:**
    - **ID do Contato:** `{contact_id}`
    - **ID do Tópico:** `{topic_id}`
    - **Trecho do Histórico Bruto Relevante (Seu Foco):** `{raw_history_snippet}`
    - **Histórico Bruto Completo (Seu Contexto):** `{full_raw_history}`

    **SEU FLUXO DE TRABALHO:**
    1.  Foque no trecho do histórico bruto fornecido, usando o histórico completo para contexto.
    2.  Reescreva e resuma o trecho para extrair a intenção e a informação essencial.
  expected_output: |
    A JSON object with two keys: `cleaned_summary` and `cleaned_details`.
    - `cleaned_summary`: A string with the corrected summary.
    - `cleaned_details`: A string with the corrected full details.

summarize_state_task:
  description: |
    Você é o **Analista de Evolução de Conversa**. Sua tarefa é executar o processo analítico definido em seu backstory para produzir um `updated_state` rico em insights.

    ---

    **DADOS PARA SUA ANÁLISE COMPARATIVA:**
    - **Estado do Último Turno (O Presente):** 
    
    `{last_turn_state}`

    - **Resumo do Histórico (O Passado):** 
    
    `{history_summary}`

    - **Mensagem do Último Turno:**

    `{client_message}`

    ---

    **SEU FLUXO DE TRABALHO ANALÍTICO:**
    1.  **Execute a ANÁLISE COMPARATIVA:** Conforme seu backstory, compare o histórico com o último turno para identificar deltas, como mudanças de intenção, sentimento ou foco.
    2.  **Execute a GERAÇÃO DE INSIGHTS:** Com base na sua análise, enriqueça o estado. Crie um `session_summary` que destaque a evolução da conversa e adicione novos metadados (ex: `intent_shift: true`, `new_concerns_raised: true`) se aplicável.
    3.  **Construa o `updated_state`:** Monte o objeto de estado final, garantindo que ele inclua todos os dados originais, mais os novos insights e metadados que você gerou. Lembre-se da regra de imutabilidade do `strategic_plan`.
  expected_output: "Um objeto JSON completo e enriquecido que segue estritamente a estrutura do modelo ConversationState. O objeto deve conter não apenas os dados fundidos, mas também os novos metadados e insights gerados a partir da sua análise comparativa."

enhance_profile_task:
  description: |
    Você é o **Arquiteto de Inteligência do Cliente**. Sua missão é executar o processo criativo detalhado em seu backstory para forjar o "Client 360° Blueprint".

    ---
    **DADOS PARA SUA ANÁLISE PROFUNDA:**
    - **Resumo do Histórico (A Jornada Passada):** `{history_summary}`
    - **Estado do Último Turno (O Momento Presente):** `{last_turn_state}`
    - **Perfil Existente (A Memória de Longo Prazo):** `{existing_profile}`
    - **Mensagem do Cliente (O Gatilho Atual):** `{client_message}`
    ---

    **SEU FLUXO DE TRABALHO CRIATIVO:**
    1.  **Construa a Identidade do Cliente:** Capture os dados básicos e, mais importante, o estilo de comunicação observado.
    2.  **Escreva a História Até Agora:** Crie um `executive_summary` narrativo e uma `interaction_timeline` com os momentos cruciais.
    3.  **Mergulhe na Mente do Cliente:** Vá além do óbvio. Infira as `primary_motivations`, `known_frustrations` e `key_interests` que definem o perfil psicológico do cliente.
    4.  **Defina a Missão Atual:** Qual é o `immediate_goal`? Quais `pending_quests` existem? E quais `information_gaps` precisamos preencher?
    5.  **Desenhe o Playbook Estratégico:** Forneça um `recommended_next_move` claro, um `conversation_path` sugerido, `potential_pitfalls` a serem evitados e `golden_opportunities` para encantar ou avançar na negociação.
    6.  **Sua saída final DEVE SER um único objeto JSON chamado `client_360_blueprint`**, seguindo o exemplo espetacular abaixo.

  expected_output: |
    {
      "client_360_blueprint": {
        "client_identity": {
          "contact_id": "71464be80c504971ae263d710b39dd1f",
          "contact_name": "Juan - Desenvolvimento",
          "phone_number": "555198906538",
          "communication_style": "Prefere texto, direto ao ponto, usa mensagens curtas e pode ser impaciente se a solução demorar."
        },
        "the_story_so_far": {
          "executive_summary": "Juan é um cliente tecnicamente inclinado que gerencia múltiplos veículos e está avaliando a Global System para uma possível parceria de frota. Ele demonstrou forte interesse em funcionalidades avançadas e no 'Plano Proteção Total PGS'. O ponto de bloqueio atual é um problema não especificado em nosso aplicativo, que interrompeu uma negociação de orçamento em andamento. A resolução deste problema técnico é a chave para reconquistar sua confiança e reabrir a oportunidade de negócio.",
          "interaction_timeline": [
            { "date": "2025-06-26", "event": "Primeiro contato, interesse no Plano PGS e verificação do status do seu dispositivo atual." },
            { "date": "2025-06-27", "event": "Solicitou um orçamento para múltiplos veículos, indicando um potencial de frota." },
            { "date": "2025-06-28", "event": "Listou funcionalidades de aplicativo que considera essenciais, como relatórios e geofencing." },
            { "date": "2025-06-30", "event": "Relatou, de forma sucinta ('?'), um problema no aplicativo, pausando todas as outras discussões." }
          ]
        },
        "clients_mindset": {
          "primary_motivations": [
            "Eficiência operacional através de tecnologia (app e relatórios).",
            "Segurança dos ativos (interesse em bloqueio, monitoramento e reembolso FIPE).",
            "Custo-benefício para uma frota de veículos."
          ],
          "known_frustrations": [
            "Aplicativos que não funcionam como esperado.",
            "Respostas lentas ou genéricas para problemas técnicos."
          ],
          "key_interests": [
            "Plano Proteção Total PGS",
            "Funcionalidades avançadas do aplicativo (geofencing, relatórios, etc.)",
            "Orçamento para múltiplos veículos."
          ]
        },
        "current_mission": {
          "immediate_goal": "Resolver o problema que está enfrentando no aplicativo.",
          "pending_quests": [
            "Receber um orçamento competitivo para sua frota de veículos.",
            "Entender a fundo os benefícios e custos dos planos oferecidos."
          ],
          "information_gaps": [
            "Qual é o problema exato no aplicativo (mensagem de erro, ação que falha)?",
            "Detalhes dos veículos da frota (tipo, modelo, ano) para o orçamento."
          ]
        },
        "strategic_playbook": {
          "recommended_next_move": "Focar 100% em diagnosticar o problema do aplicativo. Fazer perguntas diretas e claras para obter os detalhes necessários.",
          "conversation_path": [
            "1. Mostre empatia e urgência em resolver o problema do app.",
            "2. Faça as perguntas de diagnóstico (erro, versão do app, SO).",
            "3. Ofereça uma solução ou escale para o suporte técnico.",
            "4. APENAS APÓS a resolução (ou encaminhamento claro), retome suavemente o tópico do orçamento pendente."
          ],
          "potential_pitfalls": [
            "Ignorar o problema do app e tentar vender.",
            "Dar respostas genéricas de 'reinstale o app' sem diagnóstico.",
            "Demorar para responder, aumentando sua frustração."
          ],
          "golden_opportunities": [
            "Resolver o problema rapidamente para demonstrar eficiência e ganhar confiança.",
            "Usar o gancho do orçamento da frota para reengajar após a solução do problema.",
            "Oferecer uma demonstração das funcionalidades do app que ele valoriza assim que o problema for resolvido."
          ]
        }
      }
    }
