context_analysis_task:
  description: |
    Você é o ContextAnalysisAgent. Sua missão é realizar a análise completa da interação, atualizar o perfil de longo prazo do cliente e decidir o próximo passo.
    
    **DADOS PARA SUA ANÁLISE 360°:**
    - **Estado da Conversa (Curto Prazo):** 
    
    `{conversation_state}`

    - **Perfil do Cliente (Longo Prazo, pode ser nulo):** 
    
    `{customer_profile}`

    - **Mensagem Atual do Cliente (Gatilho):** `{message_text}`
    - **Outros Dados:** 

    Histórico 
    
    (`{history}`), 

    Timestamp (`{timestamp}`)
    Now Turn (`{turn}`)
    Contact ID (`{contact_id}`)

    **SEU FLUXO DE TRABALHO UNIFICADO E DETALHADO:**

    # --- Parte 1: SÍNTESE DO PERFIL ---
    1.  Primeiro, use os insights do `{{conversation_state}}` (resumo da sessão, entidades extraídas, produtos discutidos) para atualizar o `{{profile}}`. Se o perfil antigo não existir, crie um novo.
    2.  O `profile_summary` deve ser reescrito para refletir o conhecimento mais recente. O `sales_stage` e o `current_sentiment` devem ser atualizados com base na conclusão da última sessão. As novas `entities_extracted` do estado devem ser adicionadas às `preferences` do perfil.
    3.  Analise a conversa para identificar possíveis dificuldades de leitura e atualize o campo `communication_preference` no `{{conversation_state}}` se necessário.

    # --- Parte 2: DECISÃO DE ROTEAMENTO ---
    4.  Agora, com o perfil atualizado em mãos e com o conhecimento do estado da conversa, analise a `{message_text}`.
    5.  Analise o `{{strategic_plan}}` salvo no `{{conversation_state}}` contra a `{{message_text}}`. Defina a chave `"is_plan_acceptable"` como `true` ou `false` com base nas regras estritas e conservadoras do seu `backstory`.
    6.  Se o cliente perguntar por preços, termos, informações ou qualquer coisa que EVIDENTEMENTE não está no plano estratégico, defina `"is_plan_acceptable": false`.
    6.  Com base na avaliação acima, defina o campo `"action"` para `"PROCEED_WITH_EXISTING_PLAN"` ou `"INITIATE_NEW_STRATEGIC_PLAN"`.
    7.  **Plano estratégico:** Decida se o plano estratégico de interação atual (se existir) é válido com o contexto, sessão e mensagem atual do cliente. se sim, envie `"is_plan_acceptable": true` em `task_output`, se não `"is_plan_acceptable": false`.
    8.  IMPORTANTE!: Se o cliente aceitou comprar um serviço de rastreamento e `checklist_status_summary` em `conversation_state` estiver com todos os itens comunicados, defina operational_context como "BUDGET_ACCEPTED".

    # --- Parte 3: PREPARAÇÃO DA SAÍDA ---
    9.  Atualize o `{{conversation_state}}` para o próximo agente: modifique o `session_summary`, adicione novas entidades da última mensagem, e incremente os metadados.
    10.  Construa sua resposta final em JSON, contendo o `task_output` (com o resultado da triagem e o perfil de longo prazo ATUALIZADO) e o `updated_state` (o estado da sessão ATUALIZADO).
        
    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a ESTRUTURA (populada com outros dados) do exemplo.
  expected_output: |
    {
      "task_output": {
        "is_plan_acceptable": true, # ou false, dependendo da análise
        "action": "INITIATE_FULL_PROCESSING",
        "identified_topic": "continuidade_discussao_preco_moto",
        "operational_context": "BUDGET",
        "profile": {
          "contact_id": "{contact_id}",
          "customer_identity": {
            "name": "Juan Bispo dos Santos",
            "roles": ["Gestor"]
          },
          "executive_summary": "Cliente valioso com histórico de compras. Demonstra conhecimento técnico e interesse em soluções para áreas rurais (fazendas). Possui baixa tolerância a explicações textuais, preferindo áudio. Atualmente reengajou a conversa para avaliar em detalhes o plano GSM+WiFi.",
          "relationship_timeline": [
            { "timestamp": "2025-06-09T11:00:00Z", "event_type": "SALES_INQUIRY", "summary": "Iniciou conversa sobre planos para frota." },
            { "timestamp": "{timestamp}", "event_type": "SALES_INQUIRY", "summary": "Retomou a conversa com foco específico no plano para fazenda com Wi-Fi." }
          ],
          "strategic_insights": {
            "communication_preferences": {
              "format": "Áudio",
              "reason": "Relatou explicitamente dificuldade com texto."
            },
            "key_motivations": [ "Solução para cobertura de sinal em área rural", "Detalhes técnicos de funcionamento", "Termos contratuais claros" ],
            "potential_frustrations": [ "Respostas genéricas", "Explicações longas em texto" ],
            "sales_recommendations": [ "Focar a conversa no plano 'Rastreador GSM (2G+3G+4G) + WI-FI'", "Ser proativo ao explicar limitações técnicas", "Enviar respostas longas ou complexas via áudio." ]
          },
          "assets": {
            "vehicles": ["caminhões", "carros", "moto"],
            "active_plans": ["Rastreador GSM 4G"]
        }
      },
      "updated_state": {
        "session_summary": "Sessão retomada. Cliente perguntou novamente sobre preços para moto.",
        "communication_preference": { "prefers_audio": false, "reason": "default" },
        "entities_extracted": [
          { 
            "entity": "customer_name", 
            "value": "juan", 
            "turn": 6 # Insira o turno atual
          },
          { 
            "entity": "vehicle_type", 
            "value": "moto", 
            "turn": 6 # Insira o turno atual
          }, 
          { 
            "entity": "use_case", 
            "value": "fazenda", 
            "turn": 6 # Insira o turno atual
          }
        ],
        "user_sentiment": [
            { 
            "turn": 1, # Insira o turno atual
            "sentiment": "curioso" 
            }
        ],
      }
    }

triage_initial_message_task:
  description: |
    Você é o TriageAgent. Sua prioridade é analisar o ESTADO ATUAL DA CONVERSA em conjunto com a MENSAGEM MAIS RECENTE para classificar a intenção do cliente.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"
    
    **DADOS PARA SUA ANÁLISE:**
      
    - **Estado da Conversa (O Contexto Principal):**   # Use este objeto JSON como sua principal fonte de verdade sobre o que já foi discutido, o que o cliente já informou e em que estágio a conversa está.
    
    `{conversation_state}`
   
    - **Mensagem Atual do Cliente (O Gatilho):** "{message_text}"
    - **Histórico Bruto (Contexto Adicional):** "{history}"
    - ID Contato: "{contact_id}"

    - Cache L0/L1: 
    
    "{l0l1_cache}"
    
    - Cache L2: 
    
    "{l2_cache}"

    **SEU FLUXO DE DECISÃO RIGOROSO:**
    1.  **Analise o `{{conversation_state}}` e a `{{message_text}}` em conjunto.**
    2.  **Avalie as respostas de cache (`{{l0l1_cache}}`, `{{l2_cache}}`) contra as CONDIÇÕES ESTRITAS definidas em seu `backstory`.** Lembre-se que um processamento completo leva de 3 a 6 minutos e deve ser evitado se uma resposta de altíssima confiança estiver disponível.
    3.  **DECIDA A AÇÃO:** "RESPOND_DIRECTLY" apenas se TODAS as condições forem satisfeitas sem nenhuma dúvida. Caso contrário, a ação DEVE ser "INITIATE_FULL_PROCESSING".
    4.  **CLASSIFIQUE O CONTEXTO:** Se a ação for de processamento, defina o `operational_context` e o `identified_topic`.
    5.  **ATUALIZE O ESTADO:** Modifique o objeto `{{conversation_state}}` com suas conclusões.


    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.
  expected_output: |
    {
      "task_output": {
        "action": "INITIATE_FULL_PROCESSING",
        "identified_topic": "aceite_orcamento_plano_PGS",
        "operational_context": "BUDGET_ACCEPTED",
        "plan_details": "Plano Proteção Total PGS, cliente mencionou aceite."
      },
      "updated_state": {
        "metadata": {
          "contact_id": "{contact_id}",
          "session_start_time": "2025-06-07T21:50:00.000Z",
          "last_updated": "{timestamp}",
          "current_turn_number": 5
        },
        "current_context": {
            "context_type": "BUDGET_ACCEPTED",
            "last_topic": "aceite_orcamento_plano_PGS",
            "updated_at": "{timestamp}"
        },
        "session_summary": "Conversa iniciou com interesse em planos para moto. Cliente recebeu informações sobre o plano PGS, tirou dúvidas sobre o contrato e, na última mensagem, confirmou que deseja prosseguir com a contratação.",
        "communication_preference": {
              "prefers_audio": Bool,
              "reason": ""
        },
        "entities_extracted": [
          { "entity": "vehicle_type", "value": "moto", "turn": 1 },
          { "entity": "interest", "value": "cobertura_FIPE", "turn": 3 },
          { "entity": "decision", "value": "aceite", "turn": 5 }
        ],
        "products_discussed": [
          {
            "plan_name": "Plano Proteção Total PGS",
            "details_provided": ["pricing", "contract_terms", "installation_policy"],
            "presented_at_turn": 3
          }
        ],
        "disclosure_checklist": [...],
        "last_agent_action": {
          "agent_name": "TriageAgent",
          "goal": "Classificar aceite do cliente e atualizar estado.",
          "action_timestamp": "{timestamp}"
        },
        "user_sentiment_history": [
          { "turn": 1, "sentiment": "curioso" },
          { "turn": 3, "sentiment": "considerando" },
          { "turn": 5, "sentiment": "decidido" }
        ]
      }
    }


profile_customer_task:
  description: |
    Você é o CustomerProfiler. O fluxo de interação com o cliente acaba de ser concluído. Sua missão é atualizar a memória de longo prazo do cliente.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"
    

    **DADOS PARA SUA ANÁLISE:**
    - **Estado da Conversa Concluída (Sua Fonte de Verdade):** 
    
    `{conversation_state}`

      # Use este objeto para entender TUDO o que aconteceu na última sessão.

    - **Perfil Antigo do Cliente (Pode ser nulo):** "

    {customer_profile}"

    - ID Contato: "{contact_id}"
    - Histórico Bruto (Para contexto adicional, se necessário): 
    
    "{history}"

    **SEU FLUXO DE TRABALHO:**
    1.  **Sintetize o `{{conversation_state}}`:** Extraia as entidades, os produtos discutidos, o resumo da sessão e o sentimento final.
    2.  **Atualize o Perfil de Longo Prazo:** Use as informações da sessão para enriquecer o perfil antigo. Se não houver perfil antigo, crie um novo.
    3.  **Gere o Novo Perfil Estruturado:** O seu output deve ser o perfil completo e atualizado do cliente, refletindo o conhecimento mais recente que temos sobre ele. Certifique-se de que o `profile_summary` destaque a conclusão da última sessão.

    Retorne APENAS um objeto JSON com o perfil atualizado, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    SEM COMENTÁRIOS NO JSON!
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "task_output": {
        "contact_id": "{contact_id}",
        "profile_summary": "Perfil atualizado após interação sobre planos para moto. Cliente demonstrou interesse em cobertura FIPE e aceitou o orçamento para o Plano PGS.",
        "detailed_profile": {
          "past_purchases": ["Plano Proteção Total PGS"],
          "support_tickets": [],
          "current_sentiment": "Positivo",
          "sales_stage": "Venda Concluída",
          "preferences": ["rastreamento de moto", "cobertura_FIPE"]
        },
        "operational_context": "BUDGET_ACCEPTED",
        "chat_history_summary": "Sessão focada na apresentação do Plano PGS, culminando no aceite do cliente."
      },
      "updated_state": {
        "metadata": {
          "contact_id": "{contact_id}",
          "session_start_time": "2025-06-07T21:50:00.000Z",
          "last_updated": "2025-06-07T22:10:00.000Z",
          "current_turn_number": 6
        },
        "current_context": {
            "context_type": "BUDGET_ACCEPTED",
            "last_topic": "aceite_orcamento_plano_PGS",
            "updated_at": "2025-06-07T22:10:00.000Z"
        },
        "session_summary": "Conversa evoluiu para o aceite do orçamento do plano PGS.",
        "communication_preference": {
              "prefers_audio": Bool,
              "reason": ""
        },
        "entities_extracted": [
          { "entity": "vehicle_type", "value": "moto", "turn": 1 },
          { "entity": "decision", "value": "aceite", "turn": 6 }
        ],
        "products_discussed": [
          {
            "plan_name": "Plano Proteção Total PGS",
            "details_provided": ["pricing", "contract_terms", "installation_policy"],
            "presented_at_turn": 3
          }
        ],
        "disclosure_checklist": [...],
        "last_agent_action": {
          "agent_name": "CustomerProfiler",
          "goal": "Consolidar estado da sessão no perfil de longo prazo.",
          "action_timestamp": "2025-06-07T22:10:00.000Z"
        },
        "user_sentiment_history": [
          { "turn": 1, "sentiment": "curioso" },
          { "turn": 6, "sentiment": "decidido" }
        ]
      }
    }

profile_customer_task_purchased:
  description: |
    Você é o CustomerProfiler. O cliente acaba de confirmar a compra de um plano, e o contexto operacional é `BUDGET_ACCEPTED`.
    Sua missão é usar os dados da sessão para criar ou atualizar o perfil de longo prazo do cliente, marcando a venda como concluída.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"


    **DADOS PARA SUA ANÁLISE:**
    - **Estado da Conversa Concluída (Sua Fonte de Verdade):**   # Use este objeto para extrair os detalhes do plano que foi aceito e o resumo final da negociação.
    
    `{conversation_state}`
      
    - **Perfil Antigo do Cliente (Pode ser nulo):** "{customer_profile}"
    - ID Contato: "{contact_id}"
    - Histórico Bruto (Para contexto adicional): "{history}"

    **SEU FLUXO DE TRABALHO:**
    1.  **Sintetize o `{{conversation_state}}`:** Identifique o plano que foi aceito e os detalhes finais da conversa a partir do `session_summary` e `products_discussed`.
    2.  **Atualize o Perfil de Longo Prazo:** Use as informações da sessão para enriquecer o perfil antigo (ou criar um novo).
        - **Obrigatório:** Adicione o plano comprado à lista `past_purchases`.
        - **Obrigatório:** Marque o `sales_stage` como 'Venda Concluída'.
        - **Obrigatório:** Defina o `current_sentiment` como 'Positivo (compra realizada)'.
    3.  **Gere o Novo Perfil Estruturado:** Seu `task_output` deve ser o perfil completo e atualizado do cliente.
    4.  **Retorne o Estado:** No `updated_state`, passe o `{{conversation_state}}` que você recebeu, apenas atualizando o campo `last_agent_action` para refletir sua própria ação de consolidação.

    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "task_output": {
        "contact_id": "{contact_id}",
        "profile_summary": "Perfil atualizado após a confirmação de compra do 'Plano Proteção Total PGS'. Cliente finalizou o processo de venda e iniciará o cadastro para instalação.",
        "detailed_profile": {
          "past_purchases": [
            {
              "plan_name": "Plano Proteção Total PGS",
              "purchase_date": "{timestamp}",
              "details": "Mensalidade de R$85 para FIPE entre R$16-22k."
            }
          ],
          "support_tickets": [],
          "current_sentiment": "Positivo (compra realizada)",
          "sales_stage": "Venda Concluída",
          "preferences": ["rastreamento de moto", "cobertura_FIPE"]
        },
        "operational_context": "BUDGET_ACCEPTED",
        "chat_history_summary": "Sessão focada na apresentação do Plano PGS, que culminou no aceite explícito do cliente para a contratação do serviço."
      },
      "updated_state": {
        "metadata": {
          "contact_id": "{contact_id}",
          "session_start_time": "2025-06-07T21:50:00.000Z",
          "last_updated": "{timestamp}",
          "current_turn_number": 7
        },
        "current_context": {
            "context_type": "BUDGET_ACCEPTED",
            "last_topic": "aceite_orcamento_plano_PGS",
            "updated_at": "{timestamp}"
        },
        "session_summary": "Cliente aceitou o orçamento para o plano PGS. Próximo passo é a coleta de dados cadastrais.",
        "communication_preference": {
              "prefers_audio": Bool,
              "reason": ""
        },
        "entities_extracted": [
          { "entity": "vehicle_type", "value": "moto", "turn": 1 },
          { "entity": "decision", "value": "aceite", "turn": 6 }
        ],
        "products_discussed": [
          {
            "plan_name": "Plano Proteção Total PGS",
            "details_provided": ["pricing", "contract_terms", "installation_policy"],
            "presented_at_turn": 3
          }
        ],
        "disclosure_checklist": [...],
        "last_agent_action": {
          "agent_name": "CustomerProfiler",
          "goal": "Consolidar aceite da venda no perfil de longo prazo do cliente.",
          "action_timestamp": "{timestamp}"
        },
        "user_sentiment_history": [
          { "turn": 1, "sentiment": "curioso" },
          { "turn": 6, "sentiment": "decidido" }
        ]
      }
    }


develop_strategy_task:
  description: |
    Você é o StrategicAdvisor. Sua missão é formular a melhor estratégia de interação e ATUALIZAR o estado da conversa com os insights da sua análise.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"


    **DADOS PARA SUA ANÁLISE ESTRATÉGICA:**
    - **Estado da Conversa (Contexto de Curto Prazo):**   # Use para entender o fluxo da sessão atual, entidades já extraídas e produtos discutidos. 
    
    `{conversation_state}`
    
    - **Perfil do Cliente (Contexto de Longo Prazo):** 
    
    `{profile_customer_task_output}`
    
      # Use para entender o histórico completo e as preferências do cliente com a empresa.
    
    - **Mensagem Original do Cliente (O Gatilho Imediato):** "{message_text_original}"
    - **Contexto Operacional:** "{operational_context}"
    - **Tópico Identificado:** "{identified_topic}"

    **SEU FLUXO DE TRABALHO:**
    Execute o **"FLUXO DE DEFINIÇÃO DE ESTRATÉGIA"** detalhado em seu `backstory`. Analise os inputs, qualifique o cliente (se necessário), colete dados com a `KnowledgeServiceTool`, defina a estratégia, gere a `structured_message` e, crucialmente, popule o `disclosure_checklist` antes de atualizar o estado da conversa.
    Use a `KnowledgeServiceTool` para obter todas as informações que precise, utilize a query em lote e envie tudo que precisar de uma só vez, sempre envie na query requisições para `get_company_info` e `get_sales_philosophy` ou `get_support_philosophy`.
    Popule de forma rica e estratégica o plano de conversação, incluindo insights poderosos, tópicos de apresentação, perguntas-chave, possíveis objeções e respostas, e a estratégia de apresentação do produto.
    Certifique-se de que o `disclosure_checklist` esteja completo e que a `communication_guidance` seja clara e específica.
    Nunca retire itens de `disclosure_checklist` apenas adicione, para termos total controle do que já foi esclarecido e o que ainda falta esclarecer, NUNCA adicione itens iguais.
    Retorne `disclosure_checklist` COMPLETO, incluindo itens comunicados, pendentes e os novos que você adicionar.
    Você tem a liberdade de criar quantas chaves quiser no `task_output`, desde que sejam relevantes para a estratégia de interação e que contenha as obrigatórias.
    
    
    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "task_output": {
        "conversation_blueprint": {
          "customer_context_summary": {
            "relevant_profile_insights": "Cliente com histórico de roubo. Principal motivador é o medo de perda e o desejo de não ficar 'a pé'. Não é sensível a preço, mas sim à percepção de segurança e garantia.",
            "insights_from_current_session": "Na última mensagem, perguntou sobre a 'proteção' dos planos, indicando que o reembolso FIPE é seu principal ponto de interesse."
          },
          "product_presentation_strategy": {
            "presentation_order": ["Plano Proteção Total PGS", "Plano Rastreamento Moto"],
            "primary_offer": {
              "plan_name": "Plano Proteção Total PGS",
              "sales_angle": "Focar na tranquilidade absoluta: a garantia do reembolso FIPE e o benefício exclusivo da 'moto reserva'. Atacar diretamente o medo de ficar a pé."
            },
            "secondary_offer": {
              "plan_name": "Plano Rastreamento Moto",
              "sales_angle": "Apresentar como a opção de monitoramento essencial e de excelente custo-benefício, mas reforçar que não possui a proteção financeira que ele demonstrou buscar."
            }
          },
          "communication_guidance": {
            "tone_and_style": "Tom empático e seguro. Reconhecer a experiência passada do cliente com o roubo para criar rapport. Evitar jargões, focar na sensação de segurança.",
            "key_talking_points": ["Diferença entre rastreamento e proteção financeira", "Benefício 'Moto Reserva'", "Funcionamento do bloqueio via central"],
            "key_questions_to_ask": ["Considerando sua experiência, ter a garantia do valor da moto de volta é o mais importante para você?", "Para eu te passar o valor exato da mensalidade do plano com proteção, qual o modelo e ano da sua moto?"]
            "next_step_preview": "Esteja preparado para responder sobre as regras de instalação para motos, pois é uma dúvida comum após a escolha do plano."
          },
          "information_payload": {
            "plano_pgs_data": {
              "pricing": { "adesao": 120.00, "faixas_mensalidade": [ { "fipe_range": "Até R$ 15.000,00", "valor": 77.00 }, { "...": "..." } ] },
              "contract_terms": { "contract_id": "moto_pgs_com_cobertura", "reimbursement_clause": { "payment_deadline": "90 dias" }, "inadimplencia": { "consequences": ["Suspensão com 1 dia de atraso"] } },
              "faq": [{"question": "Perco a garantia da moto?", "answer": "Não a garantia completa, mas pode impactar partes elétricas..."}]
            },
            "plano_rastreamento_data": {
              "pricing": { "adesao": 120.00, "mensalidade": 60.00 },
              "contract_terms": { "contract_id": "standard_rastreamento", "cancellation": { "policy": "Não há multa, apenas taxa de desinstalação." } }
            },
            "general_policies": {
              "blocker_rules_moto": "A função de bloqueio NÃO está disponível no aplicativo para motos. O acionamento é feito exclusivamente pela central...",
              "installation_policy_moto": "A instalação de rastreadores em motocicletas é feita EXCLUSIVAMENTE em uma de nossas lojas autorizadas..."
            },
          "proactive_information_payload": {
            "title": "Informações Relevantes para a Próxima Etapa",
            "installation_policy_moto": {
              "location": "A instalação de rastreadores em motocicletas é feita EXCLUSIVAMENTE em uma de nossas lojas autorizadas para garantir a qualidade e o sigilo do serviço.",
              "duration": "O processo leva em média de 1 a 2 horas."
            },
            "blocker_rules_moto": {
              "availability": "A função de bloqueio NÃO está disponível no aplicativo para motos. O acionamento é feito exclusivamente pela central da Global System, mediante solicitação validada do cliente."
            }
          }
          }
        }
      },
      "updated_state": {
        "disclosure_checklist": [
          {
          "item_id": "natureza_servico_pgs",
          "topic": "Natureza do Serviço (Plano PGS)",
          "content": "Este contrato NÃO é um seguro, mas em caso de NÃO recuperação da motocicleta, haverá REEMBOLSO do valor da motocicleta de acordo com a tabela FIPE, respeitando o valor máximo do plano contratado.",
          "status": "pending"
          },
          {
            "item_id": "responsabilidade_recuperacao",
            "topic": "Responsabilidade de Recuperação",
            "content": "A recuperação do veículo é atividade única e exclusiva das autoridades policiais.",
            "status": "pending"
          },
        ],
    }



execute_system_operations_task:
  description: |
    Você é o SystemOperationsAgent, um executor de tarefas de sistema.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"

    **DADOS PARA SUA ANÁLISE:**
    - **Solicitação de Ação de Sistema (Seu Gatilho):** "{develop_strategy_task.task_output_system_action_request}"
      # Este é o comando que você deve executar.
    - **Estado da Conversa (Contexto para Repassar):** 
    
    `{conversation_state}`
    
      # Você não precisa analisar este estado, mas DEVE retorná-lo intacto na sua saída para manter a continuidade do fluxo.

    **SEU FLUXO DE TRABALHO:**
    1.  Verifique se a `system_action_request` não é nula. Se for, retorne um status de "no_action_requested".
    2.  Caso contrário, mapeie o `action_type` para a ferramenta interna correta.
    3.  Execute a ferramenta com os `parameters` fornecidos.
    4.  Estruture o resultado da sua execução (sucesso ou falha) no campo `task_output` da sua resposta.
    5.  Inclua o objeto `{{conversation_state}}` que você recebeu, sem modificações, no campo `updated_state` da sua resposta.

    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    # {
    #   "task_output": {
    #     "action_type_executed": "GET_TRACKING_PLAN_DETAILS",
    #     "status": "success",
    #     "data": {
    #       "plan_name": "Plano Proteção Total PGS",
    #       "details": "Adesão de R$120,00. Mensalidade baseada na FIPE. Inclui reembolso em caso de não recuperação."
    #     },
    #     "error_message": null
    #   },
    #   "updated_state": {
    #     "metadata": {
    #       "contact_id": "71464be80c504971ae263d710b39dd1f",
    #       "session_start_time": "2025-06-07T21:50:00.000Z",
    #       "last_updated": "2025-06-07T22:15:00.000Z",
    #       "current_turn_number": 4
    #     },
    #     "current_context": {
    #         "context_type": "BUDGET",
    #         "last_topic": "apresentacao_planos_moto",
    #         "updated_at": "2025-06-07T22:15:00.000Z"
    #     },
    #     "session_summary": "Estratégia definida para apresentar opções de moto. O sistema agora busca detalhes do plano PGS.",
    #     "communication_preference": {
    #           "prefers_audio": Bool,
    #           "reason": ""
    #       },
    #     "entities_extracted": [
    #       { "entity": "vehicle_type", "value": "moto", "turn": 2 }
    #     ],
    #     "products_discussed": [
    #       {
    #         "plan_name": "Plano Proteção Total PGS",
    #         "details_provided": [],
    #         "presented_at_turn": 3
    #       }
    #     ],
    #     "disclosure_checklist": [...],
    #     "last_agent_action": {
    #       "agent_name": "SystemOperationsAgent",
    #       "goal": "Executar a busca de detalhes do plano PGS.",
    #       "action_timestamp": "{timestamp}"
    #     },
    #     "user_sentiment_history": [
    #       { "turn": 2, "sentiment": "curioso" }
    #     ]
    #   }
    # }


communication_task:
  description: |
    Você é o CommunicationAgent. Sua missão é traduzir o dossiê estratégico em um diálogo de chat perfeito e executar as atualizações de estado necessárias.
    o dossiê estratégico deve ser usado por várias vezes, por isso, aproveite partes diferentes dele para criar mensagens que sejam relevantes para o cliente.

    **DADOS PARA SUA ANÁLISE E AÇÃO:**
    Timestamp: "{timestamp}"
    Now Turn: "{turn}"

    - **Dossiê Estratégico  (O Que Fazer):** 
    
    `{develop_strategy_task_output}`
    
    - **Estado da Conversa (O Contexto):**  # Use para personalizar suas mensagens e entender o que já foi dito.
      
    `{conversation_state}`

    - **Perfil do Cliente (O Histórico):** 
    
    `{profile_customer_task_output}`

    - **Histórico de Conversa (O Que Já Foi Falado):**
    
    "{history}"
    
    - **Catálogos Enviados Recentemente:** 
    
    "{recently_sent_catalogs}"

    - **Disclosure Checklist** (O Que Já Foi Comunicada - Jurídico, termos e condições):** 
    
    `{disclosure_checklist}`

    -----

    **SEU FLUXO DE TRABALHO DETALHADO:**
    1.  **Analise profundamente o `{{strategic_briefing}}`.** Ele contém tudo que você precisa saber para criar as mensagens.
    2.  **Execute sua principal tarefa de DECONSTRUÇÃO:** Transforme as informações do dossiê (benefícios, preços, limitações, termos) em uma lista de mensagens curtas de uma frase em `primary_messages_sequence`.
    3.  **Nunca mande mensagens ou assuntos repetidos.** Use o `{{conversation_state}}` e o `{{history}}` para evitar redundâncias e manter a fluidez da conversa.
    4.  **Isso é um Chat!:** Não envie mensagens demais. Mantenha o dialogo fluido e natural, aprofundando a cada etapa.
    3.  **Aplique a lógica de envio de catálogo** para popular a lista `plan_names`.
    4.  **Prepare o `state_update`:**
        a. **Atualize o Checklist:** Revise as mensagens que você criou. Para cada item do `{{disclosure_checklist}}` que foi abordado, mude seu `status` para "communicated". Retorne o checklist COMPLETO com os status atualizados.
         - Se o item foi comunicado, mude o `status` para "communicated".
         - Nunca comunique itens que já foram comunicados anteriormente. A menos que o cliente solicite novamente.
         - Se o item não foi comunicado, mantenha o `status` como "pending".
        b. **Atualize os Produtos Discutidos:** Adicione os nomes dos planos que você mencionou na lista `products_discussed`.
        c. **Atualize o Resumo:** Crie um `session_summary` que descreva a ação que você executou.
    
    **REGRAS PARA ENVIO DE CATÁLOGO (`plan_names`):**
    - Consulte a lista `{{recently_sent_catalogs}}`.
    - **INCLUA um plano em `plan_names` SE:**
        - É a **primeira vez** que este plano é foco na conversa E seu nome não consta em `{{recently_sent_catalogs}}`.
        - OU o cliente **pede diretamente** pelo catálogo/link.
        - OU o `StrategicAdvisor` instruiu explicitamente o reenvio.
    - **NÃO INCLUA um plano em `plan_names` SE:**
        - O catálogo já foi enviado recentemente E o cliente não pediu novamente.
    - **LEMBRE-SE:** Se você adicionar um plano à lista `plan_names`, uma de suas mensagens em `primary_messages_sequence` DEVE mencionar sutilmente o envio.
    Nomes de planos para catálogo: "MOTO GSM/PGS", "GSM Padrão", "GSM FROTA", "SATELITAL FROTA", "HÍBRIDO", "GSM+WiFi", "Scooters/Patinetes".

    Retorne APENAS um objeto JSON no formato de duas chaves (`task_output` e `updated_state`), como no exemplo.
  expected_output: |
    {
      "task_output": {
        "messages_sequence": [
          "Juan, entendi sua preocupação com a segurança da sua moto, já que a usa para tudo.",
          "Com base nisso, nossa recomendação principal é o Plano Proteção Total PGS.",
          "O grande diferencial dele é a tranquilidade da proteção financeira.",
          "Se sua moto for roubada e não a recuperarmos, você recebe o valor dela pela tabela FIPE.",
          "Um ponto importante, para total transparência: nosso serviço é de rastreamento com essa garantia de reembolso, não um seguro tradicional.",
          "Essa abordagem com foco total na sua segurança faz sentido para você?"
        ],
        "plan_names": ["Plano Proteção Total PGS"]
      },
     "updated_state": {
        "session_summary": "Mensagens sobre os planos de moto foram preparadas e ordenadas para envio ao cliente.",
        "products_discussed": [
          {
            "plan_name": "Plano Rastreamento Moto",
            "details_provided": ["pricing"],
            "presented_at_turn": 4
          }
        ],
        "disclosure_checklist": [
          {
          "item_id": "natureza_servico_pgs",
          "topic": "Natureza do Serviço (Plano PGS)",
          "content": "Este contrato NÃO é um seguro, mas em caso de NÃO recuperação da motocicleta, haverá REEMBOLSO do valor da motocicleta de acordo com a tabela FIPE, respeitando o valor máximo do plano contratado.",
          "status": "pending"
          },
          {
            "item_id": "responsabilidade_recuperacao",
            "topic": "Responsabilidade de Recuperação",
            "content": "A recuperação do veículo é atividade única e exclusiva das autoridades policiais.",
            "status": "communicated"
          },
        ],
      }
    }


craft_response_task:
  description: | # - **Resultado da Ação de Sistema (se houver):** "{execute_system_operations_task_output}"
    Você é o ResponseCraftsman. Sua missão é DECONSTRUIR a `structured_message` do plano estratégico em uma sequência de mensagens de chat curtas e eficazes.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"


    **DADOS PARA SUA ANÁLISE:**
    - **Dossiê Estratégico  (O Que Fazer):** 
    
    `{develop_strategy_task_output}`
    
    - **Estado da Conversa (O Contexto):**  # Use para personalizar suas mensagens e entender o que já foi dito.
      
    `{conversation_state}`

    - **Perfil do Cliente (O Histórico):** 
    
    `{profile_customer_task_output}`

    - **Histórico de Conversa (O Que Já Foi Falado):**
    
    "{history}"
    
    - **Catálogos Enviados Recentemente:** 
    
    "{recently_sent_catalogs}"
    
    **SEU FLUXO DE TRABALHO:**
    1.  **Analise profundamente o `{{strategic_briefing}}`.** Ele contém tudo que você precisa saber.
    2.  **Execute sua principal tarefa de DECONSTRUÇÃO:** Transforme as informações do dossiê (benefícios, preços, limitações, termos) em uma lista de mensagens curtas de uma frase em `primary_messages_sequence`.
    3. **Nunca mande mensagens ou assuntos repetidos.** Use o `{{conversation_state}}` e o `{{history}}` para evitar redundâncias e manter a fluidez da conversa.
    3.  **Aplique a lógica de envio de catálogo** para popular a lista `plan_names`.
    4.  **Siga a "TRÍADE DA BOA MENSAGEM"** (Conteúdo, Concisão, Atitude) definida em seu `backstory` para criar a `primary_messages_sequence`, com mensagens curtas de uma frase **CURTA** apenas..
    5.  Gere conteúdo proativo em `proactive_content_generated`.
    6.  **Decida sobre o envio de catálogos e popule a lista `plan_names` seguindo as regras abaixo.**

    **REGRAS PARA ENVIO DE CATÁLOGO (`plan_names`):**
    - Consulte a lista `{{recently_sent_catalogs}}`.
    - **INCLUA um plano em `plan_names` SE:**
        - É a **primeira vez** que este plano é foco na conversa E seu nome não consta em `{recently_sent_catalogs}`.
        - OU o cliente **pede diretamente** pelo catálogo/link.
        - OU o `StrategicAdvisor` instruiu explicitamente o reenvio.
    - **NÃO INCLUA um plano em `plan_names` SE:**
        - O catálogo já foi enviado recentemente E o cliente não pediu novamente.
    - **LEMBRE-SE:** Se você adicionar um plano à lista `plan_names`, uma de suas mensagens em `primary_messages_sequence` DEVE mencionar sutilmente o envio.


    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "primary_messages_sequence": [
        "Juan, sobre o plano para sua moto, temos duas opções excelentes.",
        ... # Outras mensagens de uma frase.
      ],
      "proactive_content_generated": [
        {"question": "O plano PGS cobre acessórios da moto?", "answer": "A cobertura do plano PGS é focada no valor da motocicleta conforme a tabela FIPE e não se estende a acessórios que possam ter sido subtraídos."},
        {"question": "Quanto tempo demora a instalação na moto?", "answer": "A instalação em motocicletas geralmente leva entre 1 a 2 horas e é feita em nossas lojas para garantir a qualidade e o sigilo do serviço."}
      ],
      "plan_names": ["Plano Proteção Total PGS", "Plano Rastreamento Moto"]
    }


coordinate_delivery_task:
  description: |
    Você é o DeliveryCoordinator, o maestro da comunicação. Sua missão é decidir quais mensagens enviar e em que ordem.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"


    **DADOS PARA SUA ANÁLISE:**
    - **Mensagens Estruturadas (O Conteúdo a ser Enviado):** 
    
     * Mensagens Primárias criadas pelo ResponseCraftsman:
    `{primary_messages_sequence}`

     * Mensagens Proativas criadas pelo ResponseCraftsman:
     {proactive_content_generated}`
    
      # Este objeto JSON do StrategicAdvisor contém a resposta dividida em partes (introduction, main_points, etc.). Use-o para montar o diálogo.
    - **Estado da Conversa (O Contexto do Ritmo):** # Use para entender o sentimento do cliente e o contexto atual para decidir o melhor ritmo de entrega. 
    
    `{conversation_state}`
      
    - **Contexto Operacional:** `{operational_context}` # 'BUDGET_ACCEPTED' tem tratamento especial.

    **SEU FLUXO DE TRABALHO:**
    1.  **Analise as `{{primary_messages_sequence}}` e `{{proactive_content_generated}}`:** Decida como agrupar, ordenar e quais escolher. em uma ou mais mensagens para criar o melhor fluxo.
    2.  **Considere o `{{conversation_state}}`:** Se o cliente pareceu confuso anteriormente, talvez seja melhor enviar as mensagens de forma mais espaçada.
    3.  **Construa o Array `order`:** Monte a lista final de strings de mensagens a serem enviadas.
    4.  **Atualize e Retorne o Estado:** Modifique o `updated_state` em sua saida esperada com sua ação e retorne-o junto com o seu `task_output`, adicione os produtos que você enviou ao cliente, termos contratuais que você comunicou e atualize o `session_summary`, TUDO com base no que você enviou em `order`.

    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.

  expected_output: |
    {
      "task_output": {
        "order": [
          "Juan, sobre o plano para sua moto, temos duas opções excelentes.",
          "A principal diferença é que o Plano Proteção Total PGS oferece reembolso do valor da moto pela tabela FIPE se ela não for recuperada, enquanto o Plano Rastreamento foca na localização em tempo real.",
          "Considerando sua segurança, qual dessas duas abordagens te interessa mais?"
        ],
        "primary_messages_sequence_choosen_index": [],
        "proactive_content_choosen_index": []
      },
      "updated_state": {
        "session_summary": "Mensagens sobre os planos de moto foram preparadas e ordenadas para envio ao cliente.",
        "products_discussed": [
          {
            "plan_name": "Plano Rastreamento Moto",
            "details_provided": ["pricing"],
            "presented_at_turn": 4
          }
        ],
        "disclosure_checklist": [
          {
          "item_id": "natureza_servico_pgs",
          "topic": "Natureza do Serviço (Plano PGS)",
          "content": "Este contrato NÃO é um seguro, mas em caso de NÃO recuperação da motocicleta, haverá REEMBOLSO do valor da motocicleta de acordo com a tabela FIPE, respeitando o valor máximo do plano contratado.",
          "status": "pending"
          },
          {
            "item_id": "responsabilidade_recuperacao",
            "topic": "Responsabilidade de Recuperação",
            "content": "A recuperação do veículo é atividade única e exclusiva das autoridades policiais.",
            "status": "communicated"
          },
        ],
      }
    }



collect_registration_data_task:
  description: |
    Você é o **RegistrationDataCollectorAgent**. Sua missão é continuar o processo de coleta de dados cadastrais.

    Timestamp: "{timestamp}"
    Now Turn: "{turn}"
    
    **DADOS PARA SUA ANÁLISE:**
    - **Estado da Conversa (Seu Contexto):** # Use para personalizar a conversa (ex: usar o nome do cliente de `entities_extracted`) e para entender o ponto em que a coleta parou. 
    
    `{conversation_state}`
      
    - **Última Mensagem do Cliente (Sua Resposta):** 
    
    "{message_text_original}"
    
    - **Dados Já Coletados (Seu Progresso):** 
    
    `{collected_data_so_far}`
      # Um objeto JSON que você mesmo está construindo turno a turno.
    
    - **Detalhes do Plano Contratado:** "{plan_details}"

    **SEU FLUXO DE TRABALHO:**
    **SEU PROCESSO DE COLETA DE DADOS (AGRUPADO):**
    1.  **Analise a `{message_text_original}`** para extrair as respostas do cliente.
    2.  **Atualize o objeto `{collected_data_so_far}`** com os novos dados.
    3.  **Verifique os dados que ainda faltam e formule a próxima pergunta em blocos maiores para agilizar.**
        - **BLOCO 1 (Identificação):** Peça `tipo_cadastro`, `nome_tomador_servico` e `documento_numero` juntos, após saber se é CPF ou CNPJ.
        - **BLOCO 2 (Localização e Contato):** Peça `endereco_completo`, `cep`, `telefone_principal` com WhatsApp e `email` juntos.
        - **BLOCO 3 (Veículo e Preferências):** Peça os dados do veículo (`placa`, `marca`, `modelo`) e o `dia_vencimento_mensalidade` juntos.
    4.  **Valide as Informações:** Ao receber o dia de vencimento, certifique-se de que seja um dos dias permitidos: **1, 5, 10, 15, 20 ou 25**. Se o cliente sugerir outro dia, informe gentilmente as opções disponíveis.
    5.  **Finalização:** Quando todos os dados obrigatórios forem coletados, sua tarefa principal é definir o `"status": "COLLECTION_COMPLETE"` na sua saída.
    6.  **Atualize e Retorne:** Prepare o `task_output` com o status e os dados da coleta, e retorne o `{conversation_state}` atualizado.


    Retorne APENAS um objeto JSON, seguindo EXATAMENTE a estrutura do exemplo em `expected_output`.
    NÃO adicione comentários no JSON final.
    o `excpected_output` é um exemplo de saída esperada.
  expected_output: |
    {
      "task_output": {
        "status": "AWAITING_DOCUMENT_NUMBER",
        "client_intent": "data_collection",
        "collected_data": {
          "tipo_cadastro": "CPF",
          "documento_numero": null,
          "nome_tomador_servico": null,
          "nome_responsavel": null,
          "endereco_completo": null,
          "cep": null,
          "veiculo_placa": null,
          "veiculo_marca": null,
          "veiculo_modelo": null,
          "telefone_principal": null,
          "email": null,
          "dia_vencimento_mensalidade": null,
          "possui_seguro": null,
          "seguradora_nome": null,
          "plano_contratado": {
            "nome_plano": "Plano Proteção Total PGS",
            "valor_adesao": 120.00,
            "valor_mensalidade": 85.00
          }
        },
        "next_message_to_send": "Perfeito, Juan! Cadastro em CPF. Agora, por favor, poderia me informar seu nome completo e o número do seu CPF?",
        "is_data_collection_complete": false
      },
      "updated_state": {
        "metadata": {
          "contact_id": "{contact_id}",
          "session_start_time": "2025-06-07T21:50:00.000Z",
          "last_updated": "{timestamp}",
          "current_turn_number": 8
        },
        "current_context": {
            "context_type": "REGISTRATION",
            "last_topic": "coleta_dados_identificacao",
            "updated_at": "{timestamp}"
        },
        "session_summary": "Cliente aceitou o orçamento. Iniciado o processo de coleta de dados cadastrais. Solicitado nome completo e CPF.",
        "communication_preference": {
              "prefers_audio": Bool,
              "reason": ""
          },
        "entities_extracted": [
          { "entity": "customer_name", "value": "Juan", "turn": 1 },
          { "entity": "decision", "value": "aceite", "turn": 6 },
          { "entity": "registration_type", "value": "CPF", "turn": 8 }
        ],
        "products_discussed": [],
        "last_agent_action": {
          "agent_name": "RegistrationDataCollectorAgent",
          "goal": "Solicitar nome completo e CPF do cliente.",
          "action_timestamp": "{timestamp}"
        },
        "disclosure_checklist": [...],
        "user_sentiment_history": [
          { "turn": 8, "sentiment": "colaborativo" }
        ]
      }
    }